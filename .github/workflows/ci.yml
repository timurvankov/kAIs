name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm run lint
      - run: pnpm run test:unit

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: kais_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
      nats:
        image: nats:latest
        ports:
          - 4222:4222
        options: >-
          --health-cmd "true"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 3
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - name: Initialize database schema
        run: |
          PGPASSWORD=test psql -h localhost -U postgres -d kais_test \
            -f helm/kais-infra/sql/init.sql \
            -f helm/kais-infra/sql/phase2.sql
      - run: pnpm run test:integration
        env:
          POSTGRES_URL: postgres://postgres:test@localhost:5432/kais_test
          NATS_URL: nats://localhost:4222

  e2e:
    name: E2E Tests (kind + Ollama)
    runs-on: ubuntu-latest
    needs: integration
    steps:
      - uses: actions/checkout@v4
      - uses: helm/kind-action@v1
        with:
          cluster_name: kais-test
      - uses: azure/setup-helm@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - name: Setup cluster (CRDs, infra, Ollama + model)
        run: bash tests/e2e/setup.sh
        env:
          KIND_CLUSTER_NAME: kais-test
      - run: pnpm run test:e2e
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Pod status ==="
          kubectl get pods -A
          echo "=== Operator logs ==="
          kubectl logs -l app=kais-operator --tail=100 || true
          echo "=== Recent events ==="
          kubectl get events --sort-by='.lastTimestamp' | tail -30

  llm-smoke:
    name: LLM Smoke Tests
    if: github.ref == 'refs/heads/main'
    environment: production
    runs-on: ubuntu-latest
    needs: unit
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - run: pnpm run test:llm-smoke
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
