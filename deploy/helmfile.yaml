repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: nats
    url: https://nats-io.github.io/k8s/helm/charts
  - name: open-telemetry
    url: https://open-telemetry.github.io/opentelemetry-helm-charts
  - name: jaegertracing
    url: https://jaegertracing.github.io/helm-charts
  - name: prometheus-community
    url: https://prometheus-community.github.io/helm-charts
  - name: grafana
    url: https://grafana.github.io/helm-charts

releases:
  - name: postgres
    namespace: kais-system
    chart: bitnami/postgresql
    values:
      - auth:
          postgresPassword: kais
          database: kais
        primary:
          initdb:
            scripts:
              init.sql: |
                CREATE TABLE IF NOT EXISTS cell_events (
                    id BIGSERIAL PRIMARY KEY,
                    cell_name TEXT NOT NULL,
                    namespace TEXT NOT NULL,
                    event_type TEXT NOT NULL,
                    payload JSONB NOT NULL,
                    created_at TIMESTAMPTZ DEFAULT NOW()
                );
                CREATE INDEX IF NOT EXISTS idx_cell_events_cell ON cell_events(namespace, cell_name);
                CREATE INDEX IF NOT EXISTS idx_cell_events_type ON cell_events(event_type);
                CREATE INDEX IF NOT EXISTS idx_cell_events_created ON cell_events(created_at);
              phase2.sql: |
                CREATE TABLE IF NOT EXISTS formations (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    name TEXT NOT NULL,
                    namespace TEXT NOT NULL DEFAULT 'default',
                    spec JSONB NOT NULL,
                    status JSONB NOT NULL DEFAULT '{"phase": "Pending"}',
                    created_at TIMESTAMPTZ DEFAULT now(),
                    updated_at TIMESTAMPTZ DEFAULT now(),
                    UNIQUE(name, namespace)
                );
                CREATE TABLE IF NOT EXISTS missions (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    name TEXT NOT NULL,
                    namespace TEXT NOT NULL DEFAULT 'default',
                    spec JSONB NOT NULL,
                    status JSONB NOT NULL DEFAULT '{"phase": "Pending", "attempt": 0}',
                    created_at TIMESTAMPTZ DEFAULT now(),
                    updated_at TIMESTAMPTZ DEFAULT now(),
                    completed_at TIMESTAMPTZ,
                    UNIQUE(name, namespace)
                );
                CREATE TABLE IF NOT EXISTS mission_checks (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
                    attempt INT NOT NULL,
                    check_name TEXT NOT NULL,
                    status TEXT NOT NULL,
                    output TEXT,
                    checked_at TIMESTAMPTZ DEFAULT now()
                );
                CREATE INDEX IF NOT EXISTS idx_mission_checks ON mission_checks(mission_id, attempt);
          persistence:
            size: 5Gi
          resources:
            requests: { memory: 256Mi, cpu: 250m }
            limits: { memory: 512Mi, cpu: 500m }

  - name: nats
    namespace: kais-system
    chart: nats/nats
    values:
      - nats:
          jetstream:
            enabled: true
            memStorage:
              enabled: true
              size: 256Mi
            fileStorage:
              enabled: true
              size: 1Gi
        cluster:
          enabled: false   # single node for minikube

  - name: ollama
    namespace: kais-system
    chart: ./helm/kais-infra/charts/ollama
    condition: ollama.enabled

  - name: otel-collector
    namespace: kais-system
    chart: open-telemetry/opentelemetry-collector
    condition: observability.enabled
    values:
      - mode: deployment
        config:
          receivers:
            otlp:
              protocols:
                grpc: { endpoint: 0.0.0.0:4317 }
                http: { endpoint: 0.0.0.0:4318 }
          processors:
            batch:
              timeout: 5s
              send_batch_size: 1024
          exporters:
            otlp/jaeger:
              endpoint: jaeger-collector.kais-system:4317
              tls: { insecure: true }
            prometheus:
              endpoint: 0.0.0.0:8889
          service:
            pipelines:
              traces:
                receivers: [otlp]
                processors: [batch]
                exporters: [otlp/jaeger]
              metrics:
                receivers: [otlp]
                processors: [batch]
                exporters: [prometheus]

  - name: jaeger
    namespace: kais-system
    chart: jaegertracing/jaeger
    condition: observability.enabled
    values:
      - collector:
          resources:
            requests: { memory: 128Mi, cpu: 100m }
        query:
          resources:
            requests: { memory: 128Mi, cpu: 100m }
        storage:
          type: badger

  - name: prometheus
    namespace: kais-system
    chart: prometheus-community/prometheus
    condition: observability.enabled
    values:
      - server:
          resources:
            requests: { memory: 256Mi, cpu: 250m }
          retention: 15d
          persistentVolume:
            size: 5Gi
        serverFiles:
          prometheus.yml:
            scrape_configs:
              - job_name: otel-collector
                static_configs:
                  - targets: ['otel-collector-opentelemetry-collector.kais-system:8889']
              - job_name: kais-operator
                static_configs:
                  - targets: ['kais-operator.kais-system:9090']

  - name: grafana
    namespace: kais-system
    chart: grafana/grafana
    condition: observability.enabled
    values:
      - adminPassword: kais
        resources:
          requests: { memory: 128Mi, cpu: 100m }
        datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                url: http://prometheus-server.kais-system
                isDefault: true
              - name: Jaeger
                type: jaeger
                url: http://jaeger-query.kais-system:16686
