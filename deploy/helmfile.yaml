repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: nats
    url: https://nats-io.github.io/k8s/helm/charts
  - name: open-telemetry
    url: https://open-telemetry.github.io/opentelemetry-helm-charts
  - name: jaegertracing
    url: https://jaegertracing.github.io/helm-charts
  - name: prometheus-community
    url: https://prometheus-community.github.io/helm-charts
  - name: grafana
    url: https://grafana.github.io/helm-charts
  - name: neo4j
    url: https://helm.neo4j.com/neo4j

releases:
  - name: postgres
    namespace: kais-system
    chart: bitnami/postgresql
    values:
      - auth:
          postgresPassword: kais
          database: kais
        primary:
          initdb:
            scripts:
              init.sql: |
                CREATE TABLE IF NOT EXISTS cell_events (
                    id BIGSERIAL PRIMARY KEY,
                    cell_name TEXT NOT NULL,
                    namespace TEXT NOT NULL,
                    event_type TEXT NOT NULL,
                    payload JSONB NOT NULL,
                    created_at TIMESTAMPTZ DEFAULT NOW()
                );
                CREATE INDEX IF NOT EXISTS idx_cell_events_cell ON cell_events(namespace, cell_name);
                CREATE INDEX IF NOT EXISTS idx_cell_events_type ON cell_events(event_type);
                CREATE INDEX IF NOT EXISTS idx_cell_events_created ON cell_events(created_at);
              phase2.sql: |
                CREATE TABLE IF NOT EXISTS formations (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    name TEXT NOT NULL,
                    namespace TEXT NOT NULL DEFAULT 'default',
                    spec JSONB NOT NULL,
                    status JSONB NOT NULL DEFAULT '{"phase": "Pending"}',
                    created_at TIMESTAMPTZ DEFAULT now(),
                    updated_at TIMESTAMPTZ DEFAULT now(),
                    UNIQUE(name, namespace)
                );
                CREATE TABLE IF NOT EXISTS missions (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    name TEXT NOT NULL,
                    namespace TEXT NOT NULL DEFAULT 'default',
                    spec JSONB NOT NULL,
                    status JSONB NOT NULL DEFAULT '{"phase": "Pending", "attempt": 0}',
                    created_at TIMESTAMPTZ DEFAULT now(),
                    updated_at TIMESTAMPTZ DEFAULT now(),
                    completed_at TIMESTAMPTZ,
                    UNIQUE(name, namespace)
                );
                CREATE TABLE IF NOT EXISTS mission_checks (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
                    attempt INT NOT NULL,
                    check_name TEXT NOT NULL,
                    status TEXT NOT NULL,
                    output TEXT,
                    checked_at TIMESTAMPTZ DEFAULT now()
                );
                CREATE INDEX IF NOT EXISTS idx_mission_checks ON mission_checks(mission_id, attempt);
          persistence:
            size: 5Gi
          resources:
            requests: { memory: 256Mi, cpu: 250m }
            limits: { memory: 512Mi, cpu: 500m }

  - name: nats
    namespace: kais-system
    chart: nats/nats
    values:
      - nats:
          jetstream:
            enabled: true
            memStorage:
              enabled: true
              size: 256Mi
            fileStorage:
              enabled: true
              size: 1Gi
        cluster:
          enabled: false   # single node for minikube

  - name: ollama
    namespace: kais-system
    chart: ./helm/kais-infra/charts/ollama
    condition: ollama.enabled

  - name: otel-collector
    namespace: kais-system
    chart: open-telemetry/opentelemetry-collector
    condition: observability.enabled
    values:
      - mode: deployment
        config:
          receivers:
            otlp:
              protocols:
                grpc: { endpoint: 0.0.0.0:4317 }
                http: { endpoint: 0.0.0.0:4318 }
          processors:
            batch:
              timeout: 5s
              send_batch_size: 1024
          exporters:
            otlp/jaeger:
              endpoint: jaeger-collector.kais-system:4317
              tls: { insecure: true }
            prometheus:
              endpoint: 0.0.0.0:8889
          service:
            pipelines:
              traces:
                receivers: [otlp]
                processors: [batch]
                exporters: [otlp/jaeger]
              metrics:
                receivers: [otlp]
                processors: [batch]
                exporters: [prometheus]

  - name: jaeger
    namespace: kais-system
    chart: jaegertracing/jaeger
    condition: observability.enabled
    values:
      - collector:
          resources:
            requests: { memory: 128Mi, cpu: 100m }
        query:
          resources:
            requests: { memory: 128Mi, cpu: 100m }
        storage:
          type: badger

  - name: prometheus
    namespace: kais-system
    chart: prometheus-community/prometheus
    condition: observability.enabled
    values:
      - server:
          resources:
            requests: { memory: 256Mi, cpu: 250m }
          retention: 15d
          persistentVolume:
            size: 5Gi
        serverFiles:
          prometheus.yml:
            scrape_configs:
              - job_name: otel-collector
                static_configs:
                  - targets: ['otel-collector-opentelemetry-collector.kais-system:8889']
              - job_name: kais-operator
                static_configs:
                  - targets: ['kais-operator.kais-system:9090']

  - name: grafana
    namespace: kais-system
    chart: grafana/grafana
    condition: observability.enabled
    values:
      - adminPassword: kais
        resources:
          requests: { memory: 128Mi, cpu: 100m }
        datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                url: http://prometheus-server.kais-system
                isDefault: true
              - name: Jaeger
                type: jaeger
                url: http://jaeger-query.kais-system:16686
        dashboardProviders:
          dashboardproviders.yaml:
            apiVersion: 1
            providers:
              - name: kais
                orgId: 1
                folder: kAIs
                type: file
                disableDeletion: false
                editable: true
                options:
                  path: /var/lib/grafana/dashboards/kais
        dashboardsConfigMaps:
          kais: kais-grafana-dashboards

  # ClickHouse for analytics (Phase 7)
  - name: clickhouse
    namespace: kais-system
    chart: bitnami/clickhouse
    condition: analytics.enabled
    values:
      - auth:
          username: kais
          password: kais
        shards: 1
        replicaCount: 1
        resources:
          requests: { memory: 512Mi, cpu: 250m }
          limits: { memory: 1Gi, cpu: 500m }
        persistence:
          size: 10Gi
        initdbScripts:
          init.sql: |
            CREATE TABLE IF NOT EXISTS cell_events_analytics (
                id UInt64,
                cell_name String,
                namespace String,
                event_type String,
                payload String,
                created_at DateTime64(3)
            ) ENGINE = MergeTree()
            ORDER BY (namespace, cell_name, created_at);

            CREATE TABLE IF NOT EXISTS experiment_traces (
                experiment_name String,
                run_id String,
                variant_key String,
                repeat UInt32,
                metric_name String,
                metric_value Float64,
                cost Float64,
                duration_ms UInt64,
                created_at DateTime64(3)
            ) ENGINE = MergeTree()
            ORDER BY (experiment_name, metric_name, created_at);

            CREATE TABLE IF NOT EXISTS cost_daily (
                date Date,
                namespace String,
                cell_name String,
                total_cost Float64,
                total_tokens UInt64,
                llm_calls UInt32
            ) ENGINE = SummingMergeTree()
            ORDER BY (date, namespace, cell_name);

            CREATE MATERIALIZED VIEW IF NOT EXISTS cost_daily_mv
            TO cost_daily AS
            SELECT
                toDate(created_at) AS date,
                namespace,
                cell_name,
                sumIf(JSONExtractFloat(payload, 'cost'), event_type = 'llm_call') AS total_cost,
                sumIf(JSONExtractUInt(payload, 'tokens'), event_type = 'llm_call') AS total_tokens,
                countIf(event_type = 'llm_call') AS llm_calls
            FROM cell_events_analytics
            GROUP BY date, namespace, cell_name;

  # Neo4j for knowledge graph (Phase 4)
  - name: neo4j
    namespace: kais-system
    chart: neo4j/neo4j-standalone
    version: 5.26.0
    condition: knowledge.enabled
    values:
      - neo4j:
          password: kais
          resources:
            requests:
              memory: 512Mi
              cpu: 500m
            limits:
              memory: 1Gi
              cpu: "1"
          volume:
            size: 10Gi
